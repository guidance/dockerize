# Akeneo 2 Local Development

Local Development Environment Powered by Docker and Docker Compose

## Prerequisites
* Docker Installed - e.g. [Docker for Mac](https://store.docker.com/editions/community/docker-ce-desktop-mac)
* Docker Compose Installed - Comes bundled with Docker for Mac, but might need to install separately
* A couple gigs of Disk Space available
* A couple gigs of Memory Available to run the Web Server, DB, and Elasticsearch

### Folder Structure
 
```
 |-- projects
     |-- project
        |-- akeneo << This is where you clone this repo  
        |-- pim-db << Folder used for storing and persisting the DB data files.
        |-- pim-es << Folder used for storing and persisting elasticsearch data files.
        |-- docker-compose.yml << File used to build the magento service.  
```

### Initial Setup

1. Create the `project` project folder
2. Create the `akeneo` folder inside of the `project` folder 
3. Clone the project Akeneo repo into the `project/akeneo` folder
4. Copy the `docker-compose.sample.yml` from `project/akeneo/devops` to the `project` project folder. 
5. Rename `docker-compose.sample.yml` to `docker-compose.yml`
6. Update any Environment Variables in `docker-compose.yml` to reflect the environment you want to build.
7. Allocate a personal github token and put in the docker compose file environment variable GITHUB_TOKEN
  Token may be created in you GitHub account: Settings / Developer settings / Personal access tokens / Generate New Token
8. Un-comment the PIM_FRESH_INSTALL environment variable (this will install the PIM DB). Make a note to re-comment that so that you don't wipe out your install next time.

### Start Development Stack

> This stack provides a basic environment for Akeneo 2.x Development using the same environment that will be built and deployed to the dev/stage/production environments.

1. Perform Intial Setup (above)
2. Run `docker-compose up` from the `project` project folder
_This will attach the terminal to the containers and output useful information from all the containers including the magento applcation from the `pim` service container._
3. If desired, update your local `/etc/hosts` file to point a local domain site to `127.0.0.1`.
4. Because this project doesn't have the vendor directory as part of the code base, we don't get the composer files that are generated by the install... so capture those, we need to copy those down to our local after the composer install finishes as part of the akeneo setup/configure script.
- `docker cp [container id|name]:/app/vendor ./akeneo/` - Copies the vendor folder from the container to your local.
- `docker-compose build pim` - Re-build the pim image with the vendor files in it.

## Development

Akeneo 2 is based on the Symfony framework. 

The vendor directory is populated as part of the composer install that is run as part of the setup script (see: `devops/akeneo-config.sh`) 

For custom development Symfony Bundles are created to extend and create functionality within the Akeneo platform. 

These bundles are added to the `src` directory. 

### File Sharing between host and containers

The sample docker-compose.yml file has some the volumes section commented out in the pim service section. After you have a version of Akeneo running, you will want to copy the files to your local host, then share some volumes back to the containers. 
The following container paths should be copied down:
 - /app/app
 - /app/node_modules
 - /app/vendor

Then you should add the following to the docker-compose.yml `pim` service:
 volumes:
   - ./akeneo/app:/app/app
   - ./akeneo/src:/app/src

### Development Process

After you make changes to the bundles in the src directory, and register them in the AppKernel.php you need to run some commands in Akeneo to get all the underlying "stuff" built up. 

See the `devops/akeneo-config.sh` script `installandupgrade` function. The full command can be run at any time to re-build the akeneo internals and frontend applications. 

From within the container run: `akeneo-config.sh /app configure` to just run everything that is needed after changes. 

> IMPORTANT: Note the PIM_FRESH_INSTALL environment variable. You will need to comment that out of the docker-compose.yml and restart the stack so that your DB doesn't get wiped... unless of course you want that. ;)
